const t=z,e=t.z.object({resource_preload:t.z.string().default('')}),a={type:'script',script_id:getScriptId()};const n=async(t,e,a=0)=>{const n=[];let s=0;const c=Array(Math.min(e,t.length)).fill(null).map(async(_,e)=>{a>0&&e>0&&await new Promise(t=>setTimeout(t,a*e)),await(async()=>{for(;s<t.length;){const e=s++,a=t[e];try{const t=await a();n[e]={status:'fulfilled',value:t}}catch(t){n[e]={status:'rejected',reason:t}}}})()});return await Promise.all(c),n},s=async t=>{await(t=>new Promise(e=>{const a=new Image;a.crossOrigin='anonymous',a.onload=()=>e(),a.onerror=()=>e(),a.src=t}))(t),await(async t=>{if('caches'in window)try{const e=await caches.open('destined-journey-cache-v1');if(await e.match(t))return;const a=await fetch(t,{mode:'cors'});a.ok&&await e.put(t,a.clone())}catch(e){console.warn('[ImagePreload] Lưu tài nguyên vào bộ nhớ đệm thất bại:',t,e)}})(t)};$(()=>{const t=_.uniq(function(){const t=e.parse(getVariables(a));return insertVariables(t,a),_(getTavernRegexes()).filter(t=>t.enabled&&t.script_name.includes('Preload-')).map(t=>({title:t.script_name.replace('Preload-','').replaceAll(/【.+?】/gs,''),content:t.replace_string})).concat([{title:'Biến kịch bản',content:t.resource_preload}]).map(({title:t,content:e})=>({title:t,assets:e.split('\n').map(t=>t.trim()).filter(t=>!!t)})).value()}().flatMap(t=>t.assets)),c=t.map(t=>()=>s(t));n(c,4,100).then(e=>{const a=e.filter(t=>'fulfilled'===t.status).length,n=e.filter(t=>'rejected'===t.status).length;t.length>0&&console.log(`[ImagePreload] Tải trước hoàn tất: ${a} thành công, ${n} thất bại, tổng cộng ${t.length} tài nguyên`)})});