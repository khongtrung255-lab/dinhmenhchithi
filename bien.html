import'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';import'https://testingcf.jsdelivr.net/npm/json5/+esm';import'https://testingcf.jsdelivr.net/npm/jsonrepair/+esm';import{toDotPath as t}from'https://testingcf.jsdelivr.net/npm/zod/v4/core/+esm';import{klona as e}from'https://testingcf.jsdelivr.net/npm/klona/+esm';var r={};r.d=(t,e)=>{for(var n in e)r.o(e,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const n=z;function s(r){const s=()=>{const t='function'==typeof r?r():r,e=t instanceof n.z.ZodObject?n.z.looseObject(t.shape):t;return'function'==typeof registerVariableSchema&&registerVariableSchema(n.z.object({stat_data:e}),{type:'message'}),e};s(),eventOn('mag_variable_initialized',(t,e)=>{const r=s();try{const s=r.safeParse(_.get(t,'stat_data',{}),{reportInput:!0});if(s.success)return void(t.stat_data={...t.stat_data,...s.data});a('error',n.z.prettifyError(s.error),`Bắt đầu '${e+1}' khởi tạo biến thất bại`)}catch(t){const r=t;a('error',r.stack?r.stack:r.name+': '+r.message,`Khởi tạo biến của lời mở đầu thứ ${e+1} thất bại`)}}),eventOn('mag_command_parsed_for_zod',(r,n)=>{const o=s(),l=Boolean($('#mvu_notification_error').prop('checked')),u=(e,r,n)=>{let s='';try{const r=o.safeParse(e,{reportInput:!0});if(r.success)return r.data;i=r.error,s=_([...i.issues]).sortBy(t=>t.path?.length??0).flatMap(e=>{const r=[`✖ ${e.message}`];return e.path?.length&&r.push(`  → Đường dẫn: ${t(e.path)}`),void 0!==e.input&&r.push(`  → Input: ${JSON.stringify(e.input)}`),r}).join('\n')}catch(t){const e=t;s=e.stack?e.stack:e.name+': '+e.message}var i;return l&&n&&a('warn',s,`Xảy ra lỗi cập nhật biến, có thể cần Re-roll: ${r.full_match}`),null},p=(t,r)=>{switch(r.type){case'set':{3===r.args.length&&r.args.splice(1,1);const e=i(r.args[0]);return e?_.set(t,e,c(r.args[1])):t=c(r.args[1]),u(t,r,!0)}case'add':{const e=i(r.args[0]);if(!e)return null;const n=_.get(t,e),s=typeof n;if('number'!==s)return l&&a('warn',[`✖ Không thể thực hiện phép toán cộng trừ trên kiểu phi số '${s}'`,`  → Đường dẫn: ${e}`,`  → Giá trị gốc: ${JSON.stringify(n)}`].join('\n'),`Xảy ra lỗi cập nhật biến, có thể cần Re-roll: ${r.full_match}`),null;const o=c(r.args[1]);return _.update(t,e,t=>t+Number(o)),u(t,r,!0)}case'insert':{const n=i(r.args[0]),s=c(r.args[1]),a=c(r.args.at(-1)),o=(t,e)=>{const o=''===n?t:_.get(t,n),i=_.isArray(o);return 2===r.args.length?i?o.push(a):_.assign(o,a):i?o.splice('-'===s?o.length:s,0,a):o[String(s)]=a,u(t,r,e)},l=''===n?t:_.get(t,n),p=_.isNil(l);if(!p&&!_.isArray(l)&&!_.isPlainObject(l))return null;if(!p)return o(t,!0);const f=_(e(t)),g=o(f.set(n,{}).value(),!1);return g||o(f.set(n,[]).value(),!0)}case'delete':{const e=r.args.map(i).join('.'),n=_(e).toPath().value(),s=_(n).dropRight().join('.');return _.isArray(_.get(t,s))?_.pullAt(_.get(t,s),Number(_(n).last())):_.unset(t,e),u(t,r,!0)}}},f=e(r.stat_data);for(const t of n){let n=e(r.stat_data);if('move'===t.type){const e=i(t.args[0]);if(!_.has(n,e)){l&&a('warn',`Đường dẫn nguồn di chuyển không tồn tại: ${e}`,`Xảy ra lỗi cập nhật biến, có thể cần Re-roll: ${t.full_match}`);continue}const r=_.get(n,e),s=i(t.args[1]);n=p(n,{...t,type:'delete',args:[e]}),n=p(n,{...t,type:'set',args:[s,r]})}else n=p(n,t);null!==n&&(r.stat_data={...r.stat_data,...n})}!function(t,e){!function r(n,s=[]){_.isObjectLike(n)&&_.forOwn(n,(n,a)=>{const o=[...s,a];if(a.startsWith('_')){const r=_.get(e,o);void 0!==r&&_.set(t,o,r)}_.isObjectLike(n)&&r(n,o)})}(t)}(r.stat_data,f),n.length=0}),eventOn('mag_command_parsed_ended_for_zod',(t,e)=>{e.length=0}),eventOn('mag_variable_update_ended_for_zod',t=>{_.set(t,'schema','Không có tác dụng gì đâu đừng quan tâm'),_.unset(t,'display_data'),_.unset(t,'delta_data')}),console.info('Đăng ký cấu trúc biến thành công')}function a(t,e,r){toastr['warn'===t?'warning':'error'](e.replaceAll('\n','<br>'),'[MVU zod]'+r,{escapeHtml:!1}),console[t](`${r}\n${e}`)}function o(t){return t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1')}function i(t){return o(t).replace(/^(?:stat_data|status_current_variables)\./,'')}function c(t){const e=function(t){const e=t.trim();if('true'===e)return!0;if('false'===e)return!1;if('null'===e)return null;if('undefined'===e)return;try{return JSON.parse(e)}catch(t){if(e.startsWith('{')&&e.endsWith('}')||e.startsWith('[')&&e.endsWith(']'))try{const t=new Function(`return ${e};`)();if(_.isObject(t)||Array.isArray(t))return t}catch(t){}}try{return YAML.parse(e)}catch(t){}return o(t)}(t);return e instanceof Date?e.toISOString():Array.isArray(e)?e.map(t=>t instanceof Date?t.toISOString():t):e}export{s as registerMvuSchema};