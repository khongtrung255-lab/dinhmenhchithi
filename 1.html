<!doctype html><html lang="vi-VN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Mệnh Định Chi Thi và Hoàng Hôn Chi Ca</title><script type="module">import{default as e}from'https://testingcf.jsdelivr.net/npm/json5/+esm';var t={946(e,t){t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}}},a={};const n=Vue;function l(){const e=window.top?.TavernHelper.getCharWorldbookNames('current');return e?e.primary:null}async function o(e,t){const a=await async function(e){if(!e)return;const t=await(window.top?.TavernHelper.getWorldbook(e));return t?t.map(e=>({name:e.name,enabled:e.enabled})):void 0}(t);return a&&0!==a.length?a.filter(t=>e.test(t.name)).map(e=>({name:e.name,enabled:e.enabled})):[]}async function s(e,t){if(!t)return;if(!t)throw new Error('No worldbook bound to current character');const a=new Map(e.map(e=>[e.name,e.enabled]));await(window.top?.TavernHelper.updateWorldbookWith(t,e=>e.map(e=>{const t=a.get(e.name);return void 0!==t?{...e,enabled:t}:e})))}const c='Đây là cái chén gì',r='Đặc biệt gợi ý',i=/^命定系统-/,u=/\(([^)]*)\)$/,d={coreOptions:[],localCoreSelections:new Map,tabs:[],activeTab:''};let v=null,m=null;const p='https://testingcf.jsdelivr.net/gh/The-poem-of-destiny/FrontEnd-for-destined-journey@1.4.19/public/assets/data';async function f(){const t=await async function(){if(null!==v)return v;try{const t=await fetch(`${p}/coreClassification.json`);if(!t.ok)return console.log('Không tìm thấy tệp dữ liệu phân loại lõi (coreClassification.json)'),{};const a=await t.text(),n=e.parse(a);return console.log('Đã tải thành công dữ liệu phân loại lõi'),v=n,n}catch(e){return console.log('Không tìm thấy dữ liệu phân loại lõi hoặc định dạng bị lỗi:',e),{}}}();if(!t||'object'!=typeof t)return[r,c];const a=Object.keys(t).filter(e=>t[e]&&'object'==typeof t[e]);return 0===a.length?[r,c]:[r,...a,c]}function b(e,t){const a=v??void 0,n=[];let l='';if(a&&'object'==typeof a)for(const o of t){if(o===c||o===r)continue;const t=a[o];t&&'object'==typeof t&&e in t&&(n.push(o),!l&&t[e]?.note&&(l=t[e].note))}return 0===n.length?{tabs:[c],note:''}:{tabs:n,note:l}}function g(e){for(const[t,a]of e)if(a)return t;return null}async function k(e={}){const t=await f(),a=l(),n=await o(i,a),s=function(e,t){const a=[];let n=0;for(const[l,o]of Object.entries(e)){if(n>=3)break;const e=l.replace(/^命定系统-/,''),s=e.match(/\(([^)]*)\)$/),c=s?s[1]:'',r=e.replace(/\(([^)]*)\)$/,'');a.push({value:l,label:r,author:c,specialNote:o.note,available:t.has(l)}),n++}return a}(e,new Set(n.map(e=>e.name))),c=new Set(s.filter(e=>e.available).map(e=>e.value)),d=n.map(e=>{const a=e.name.replace(i,''),n=a.match(u),l=n?n[1]:'',o=a.replace(u,''),d=b(o,t),v=[...d.tabs];let m='';if(c.has(e.name)){v.unshift(r);const t=s.find(t=>t.value===e.name);m=t?.specialNote||''}return{value:e.name,label:o,author:l,enabled:e.enabled,tabs:v,note:d.note,specialNote:m}}),v=new Map(d.map(e=>[e.value,e.enabled])),m=t[0]||r;return{coreOptions:d,localCoreSelections:v,tabs:t,activeTab:m,bookName:a,specialRecommendCoreList:s}}const E={class:'core-page'},y={class:'control-panel-container'},h={class:'tab-navigation'},N=['disabled'],V={class:'tab-buttons-container'},w=['onClick'],C={class:'tab-label'},x={key:0,class:'tab-count'},B=['disabled'],S=['disabled'],T={class:'tab-content'},D={class:'control-group'},M={key:0,class:'loading-text'},K={key:1,class:'empty-text'},q={class:'special-recommend-container'},O={class:'special-recommend-cards'},j=['onClick'],A={key:0,class:'card-overlay'},L={class:'card-content'},P={class:'card-label'},I={key:0,class:'card-author'},F={class:'card-note'},R={class:'control-buttons'},H=['onClick'],W={key:0,class:'core-author'},J={key:1,class:'core-note'},U={class:'step-footer'},G=['disabled'],Y=['disabled'],Q=(0,n.defineComponent)({__name:'CorePage',emits:['prev','next'],setup(t,{emit:a}){const l=a,o=(0,n.ref)(!1),c=(0,n.ref)(!1),i=(0,n.ref)([...d.tabs]),u=(0,n.ref)(d.activeTab),v=(0,n.ref)([...d.coreOptions]),f=(0,n.ref)(new Map(d.localCoreSelections)),b=(0,n.ref)(null),Q=(0,n.ref)([]),X=(0,n.ref)(0),Z=(0,n.computed)(()=>g(f.value)),ee=(0,n.computed)(()=>u.value===r),te=(0,n.computed)(()=>i.value.length>4),ae=(0,n.computed)(()=>te.value?i.value.slice(X.value,X.value+4):i.value);function ne(){X.value>0&&(X.value=Math.max(0,X.value-4))}function le(){X.value+4<i.value.length&&(X.value=Math.min(i.value.length-4,X.value+4))}function oe(e){return function(e,t){return e.filter(e=>e.tabs.includes(t))}(v.value,e)}async function se(){o.value=!0;try{const t=await async function(){if(null!==m)return m;try{const t=await fetch(`${p}/SPECIAL_RECOMMEND_CORES.json`);if(!t.ok)return console.log('Không tìm thấy tệp dữ liệu lõi đặc biệt gợi ý (SPECIAL_RECOMMEND_CORES.json)'),{};const a=await t.text(),n=e.parse(a);return console.log('Đã tải thành công dữ liệu lõi đặc biệt gợi ý'),m=n,n}catch(e){return console.log('Không tìm thấy dữ liệu lõi đặc biệt gợi ý hoặc định dạng bị lỗi:',e),{}}}(),a=await k(t);i.value=a.tabs,v.value=a.coreOptions,f.value=a.localCoreSelections,u.value=a.activeTab,b.value=a.bookName,Q.value=a.specialRecommendCoreList}catch(e){console.error('Lỗi khi tải danh sách lõi:',e),i.value=[],v.value=[],f.value=new Map,b.value=null,Q.value=[]}finally{o.value=!1}}async function ce(){await se()}function re(e){f.value=function(e,t){if(g(e)===t)return e;const a=new Map;for(const[n]of e)a.set(n,n===t);return a}(f.value,e)}async function ie(){c.value=!0;try{b.value&&(v.value=await async function(e,t,a){if(!function(e,t){for(const a of e)if((t.get(a.value)??!1)!==a.enabled)return!0;return!1}(e,t))return e;const n=Array.from(t).map(([e,t])=>({name:e,enabled:t}));return await s(n,a),e.map(e=>({...e,enabled:t.get(e.value)??!1}))}(v.value,f.value,b.value))}catch(e){console.error('Lưu lựa chọn lõi thất bại:',e)}finally{c.value=!1}l('next')}return(0,n.watch)(u,e=>{const t=i.value.indexOf(e);-1!==t&&te.value&&(t<X.value?X.value=t:t>=X.value+4&&(X.value=t-4+1))}),(0,n.onMounted)(()=>{se()}),(e,t)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',E,[t[5]||(t[5]=(0,n.createElementVNode)('h2',{class:'main-title'},'Lựa chọn lõi',-1)),(0,n.createElementVNode)('div',y,[(0,n.createCommentVNode)(' Tab Điều hướng '),(0,n.createElementVNode)('div',h,[te.value?((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:0,class:'arrow-button',disabled:0===X.value,title:'Trang trước',onClick:ne},[...t[1]||(t[1]=[(0,n.createElementVNode)('span',null,'‹',-1)])],8,N)):(0,n.createCommentVNode)('v-if',!0),(0,n.createElementVNode)('div',V,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(ae.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:e,class:(0,n.normalizeClass)(['tab-button',{active:u.value===e,'special-recommend-tab':e===(0,n.unref)(r)}]),onClick:t=>u.value=e},[(0,n.createElementVNode)('span',C,(0,n.toDisplayString)(e),1),e!==(0,n.unref)(r)?((0,n.openBlock)(),(0,n.createElementBlock)('span',x,'('+(0,n.toDisplayString)(oe(e).length)+')',1)):(0,n.createCommentVNode)('v-if',!0)],10,w))),128))]),te.value?((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:1,class:'arrow-button',disabled:X.value+4>=i.value.length,title:'Trang sau',onClick:le},[...t[2]||(t[2]=[(0,n.createElementVNode)('span',null,'›',-1)])],8,B)):(0,n.createCommentVNode)('v-if',!0),(0,n.createElementVNode)('button',{class:'refresh-button',disabled:o.value,title:'Làm mới danh sách',onClick:ce},[(0,n.createElementVNode)('span',{class:(0,n.normalizeClass)({'is-spinning':o.value})},'⟳',2)],8,S)]),(0,n.createElementVNode)('div',T,[(0,n.createElementVNode)('div',D,[o.value?((0,n.openBlock)(),(0,n.createElementBlock)('div',M,'Đang tải danh sách lõi...')):0===v.value.length?((0,n.openBlock)(),(0,n.createElementBlock)('div',K,'Không tìm thấy lõi khả dụng')):ee.value?((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:2},[(0,n.createCommentVNode)(' Hiển thị đặc biệt gợi ý - Bố cục thẻ '),(0,n.createElementVNode)('div',q,[t[3]||(t[3]=(0,n.createStaticVNode)('<div class="recommend-hero-section" data-v-71beb012><div class="hero-icon" data-v-71beb012>✦</div><div class="hero-content" data-v-71beb012><h3 class="hero-title" data-v-71beb012>Lựa chọn tuần này</h3><p class="hero-subtitle" data-v-71beb012>Các lõi chất lượng(?) được bình chọn bởi <s>cộng đồng</s> và biên tập viên</p></div><div class="hero-divider" data-v-71beb012></div></div>',1)),(0,n.createElementVNode)('div',O,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(Q.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('div',{key:e.value,class:(0,n.normalizeClass)(['special-recommend-card',{unavailable:!e.available,selected:Z.value===e.value}]),onClick:t=>e.available&&re(e.value)},[e.available?(0,n.createCommentVNode)('v-if',!0):((0,n.openBlock)(),(0,n.createElementBlock)('div',A)),(0,n.createElementVNode)('div',L,[(0,n.createElementVNode)('div',P,(0,n.toDisplayString)(e.label),1),e.author?((0,n.openBlock)(),(0,n.createElementBlock)('div',I,(0,n.toDisplayString)(e.author),1)):(0,n.createCommentVNode)('v-if',!0),(0,n.createElementVNode)('div',F,[e.available?e.specialNote?((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:1},[(0,n.createTextVNode)((0,n.toDisplayString)(e.specialNote),1)],64)):(0,n.createCommentVNode)('v-if',!0):((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:0},[(0,n.createTextVNode)('Không khả dụng')],64))])])],10,j))),128))])])],2112)):((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:3},[(0,n.createCommentVNode)(' Hiển thị lõi thông thường '),(0,n.createElementVNode)('div',R,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(oe(u.value),e=>((0,n.openBlock)(),(0,n.createElementBlock)('div',{key:e.value,class:'control-item-wrapper'},[(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['control-button',{selected:Z.value===e.value}]),onClick:t=>re(e.value)},(0,n.toDisplayString)(e.label),11,H),e.author?((0,n.openBlock)(),(0,n.createElementBlock)('div',W,(0,n.toDisplayString)(e.author),1)):(0,n.createCommentVNode)('v-if',!0),e.note?((0,n.openBlock)(),(0,n.createElementBlock)('div',J,(0,n.toDisplayString)(e.note),1)):(0,n.createCommentVNode)('v-if',!0)]))),128))])],2112))])])]),(0,n.createElementVNode)('div',U,[(0,n.createElementVNode)('button',{class:'nav-button',disabled:c.value,onClick:t[0]||(t[0]=t=>e.$emit('prev'))},[...t[4]||(t[4]=[(0,n.createElementVNode)('span',null,'Bước trước',-1)])],8,G),(0,n.createElementVNode)('button',{class:'nav-button',disabled:o.value||c.value,onClick:ie},[(0,n.createElementVNode)('span',null,(0,n.toDisplayString)(c.value?'Đang lưu...':'Bước sau'),1)],8,Y)])]))}});var X=function e(n){var l=a[n];if(void 0!==l)return l.exports;var o=a[n]={exports:{}};return t[n](o,o.exports,e),o.exports}(946);const Z=(0,X.A)(Q,[['__scopeId','data-v-71beb012']]);function ee(e,t){return e.localeCompare(t,'vi-VN',{sensitivity:'base'})}const te=/^\[角色\]/,ae=/^(.+?)(?:\(([^)]+)\))?$/,ne={characterOptions:[],localCharacterSelections:new Map},le=/^\[事件\]/,oe=/^(\[事件\]\[[^\]]+\])/,se=/^\[事件\]\[([^\]]+)\]/,ce=/\(([^)]+)\)(?=[^()]*$)/,re={eventOptions:[],localEventSelections:new Map},ie=/^\[扩展\]/,ue=/^(\[扩展\]\[[^\]]+\])/,de=/^\[扩展\]\[([^\]]+)\]/,ve=/\[!([^\]]+)\]/g,me=/\[>([^\]]+)\]/g,pe=/\[<([^\]]+)\]/g,fe={extensionOptions:[],localExtensionSelections:new Map};async function be(){const e=l(),t=(await o(te,e)).map(e=>{const{label:t,author:a,info:n}=function(e){const t=e.replace(te,''),a=t.match(ae);if(a){const e=a[2]?.trim()||'',t=e.indexOf('-');return t>0?{label:a[1].trim(),author:e.substring(0,t).trim(),info:e.substring(t+1).trim()}:{label:a[1].trim(),author:e,info:''}}return{label:t,author:'',info:''}}(e.name);return{value:e.name,label:t,author:a,info:n,enabled:e.enabled}}),a=(n=t,[...n].sort((e,t)=>ee(e.label,t.label)));var n;const s=new Map(a.map(e=>[e.value,e.enabled]));return{characterOptions:a,localCharacterSelections:s,bookName:e}}function ge(e){const t=e.match(oe);return t?t[1]:null}function ke(e){const t=e.match(se);return t?t[1]:e}function Ee(e){for(const t of e){const e=t.name.match(ce);if(e){const t=e[1].trim(),a=t.indexOf('-');return a>0?{author:t.substring(0,a).trim(),info:t.substring(a+1).trim()}:{author:t,info:''}}}return{author:'',info:''}}async function ye(){const e=l(),t=await o(le,e),a=new Map;for(const e of t){const t=ge(e.name);t&&(a.has(t)||a.set(t,[]),a.get(t).push({name:e.name,enabled:e.enabled}))}const n=[];for(const[e,t]of a){const a=t.every(e=>e.enabled),{author:l,info:o}=Ee(t);n.push({eventKey:e,label:ke(e),author:l,info:o,entries:t,enabled:a})}const s=(c=n,[...c].sort((e,t)=>ee(e.label,t.label)));var c;const r=new Map(s.map(e=>[e.eventKey,e.enabled]));return{eventOptions:s,localEventSelections:r,bookName:e}}function he(e){const t=e.match(ue);return t?t[1]:null}function Ne(e){const t=e.match(de);return t?t[1]:e}function Ve(e){const t=[],a=new RegExp(ve.source,'g');let n;for(;null!==(n=a.exec(e));)t.push(n[1]);return t}function we(e){const t=[],a=new RegExp(me.source,'g');let n;for(;null!==(n=a.exec(e));)t.push(n[1]);return t}function Ce(e){const t=[],a=new RegExp(pe.source,'g');let n;for(;null!==(n=a.exec(e));)t.push(n[1]);return t}function xe(e){const t=new Set;for(const a of e){Ve(a.name).forEach(e=>t.add(e))}return Array.from(t)}function Be(e){const t=new Set;for(const a of e){we(a.name).forEach(e=>t.add(e))}return Array.from(t)}function Se(e){const t=new Set;for(const a of e){Ce(a.name).forEach(e=>t.add(e))}return Array.from(t)}function Te(e){for(const t of e){const e=t.name.match(ce);if(e){const t=e[1].trim(),a=t.indexOf('-');return a>0?{author:t.substring(0,a).trim(),info:t.substring(a+1).trim()}:{author:t,info:''}}}return{author:'',info:''}}async function De(){const e=l(),t=await o(ie,e),a=new Map;for(const e of t){const t=he(e.name);t&&(a.has(t)||a.set(t,[]),a.get(t).push({name:e.name,enabled:e.enabled}))}const n=[];for(const[e,t]of a){const a=t.every(e=>e.enabled),{author:l,info:o}=Te(t);n.push({extensionKey:e,label:Ne(e),author:l,info:o,exclusionTargets:xe(t),replacementTargets:Be(t),prerequisiteTargets:Se(t),entries:t,enabled:a})}const s=(c=n,[...c].sort((e,t)=>ee(e.label,t.label)));var c;const r=new Map(s.map(e=>[e.extensionKey,e.enabled]));return{extensionOptions:s,localExtensionSelections:r,bookName:e}}async function _e(e,t,a){if(!function(e,t){for(const a of e)if((t.get(a.extensionKey)??!1)!==a.enabled)return!0;return!1}(e,t))return e;const n=new Map(e.map(e=>[e.extensionKey,e.enabled])),l=[];for(const a of e){const e=t.get(a.extensionKey)??!1;for(const t of a.entries)l.push({name:t.name,enabled:e})}const c=function(e,t){const a=[];for(const n of e)t.get(n.extensionKey)&&n.exclusionTargets.length>0&&a.push(...n.exclusionTargets);return[...new Set(a)]}(e,t),r=function(e,t){const a=[];for(const n of e)t.get(n.extensionKey)&&n.replacementTargets.length>0&&a.push(...n.replacementTargets);return[...new Set(a)]}(e,t),i=function(e,t,a){const n=[];for(const l of e){const e=t.get(l.extensionKey)??!1,o=a.get(l.extensionKey)??!1;!e&&o&&l.replacementTargets.length>0&&n.push(...l.replacementTargets)}return[...new Set(n)]}(e,t,n),u=i.filter(e=>!r.includes(e)&&!c.includes(e));if(c.length>0)for(const e of c){const t=new RegExp(`\\[${Me(e)}\\]`),n=await o(t,a);for(const e of n){const t=l.findIndex(t=>t.name===e.name);-1===t?l.push({name:e.name,enabled:!1}):l[t].enabled=!1}}if(r.length>0)for(const e of r){const t=new RegExp(`\\[${Me(e)}\\]`),n=await o(t,a);for(const e of n){const t=l.findIndex(t=>t.name===e.name);-1===t?l.push({name:e.name,enabled:!1}):l[t].enabled=!1}}if(u.length>0)for(const e of u){const t=new RegExp(`\\[${Me(e)}\\]`),n=await o(t,a);for(const e of n){const t=l.findIndex(t=>t.name===e.name);-1===t?l.push({name:e.name,enabled:!0}):!1!==l[t].enabled&&(l[t].enabled=!0)}}return await s(l,a),e.map(e=>{const a=t.get(e.extensionKey)??!1;return{...e,enabled:a,entries:e.entries.map(e=>({...e,enabled:a}))}})}function Me(e){return e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}const Ke={class:'settings-page'},qe={class:'control-panel-container'},Oe={class:'tab-navigation'},je=['disabled'],Ae={class:'tab-content'},ze={class:'control-group'},Le={key:0,class:'loading-text'},Pe={key:1,class:'empty-text'},Ie={key:2,class:'list-detail-layout'},$e={class:'item-list'},Fe=['onClick'],Re={class:'item-detail'},He={class:'detail-name'},We={class:'detail-row'},Je={class:'detail-value'},Ue={class:'detail-row'},Ge={class:'detail-value'},Ye={class:'detail-actions'},Qe={key:1,class:'detail-placeholder'},Xe={class:'control-group'},Ze={key:0,class:'loading-text'},et={key:1,class:'empty-text'},tt={key:2,class:'list-detail-layout'},at={class:'item-list'},nt=['onClick'],lt={class:'item-detail'},ot={class:'detail-name'},st={class:'detail-row'},ct={class:'detail-value'},rt={class:'detail-row'},it={class:'detail-value'},ut={class:'detail-row'},dt={class:'detail-value'},vt={class:'detail-actions'},mt={key:1,class:'detail-placeholder'},pt={class:'control-group'},ft={key:0,class:'loading-text'},bt={key:1,class:'empty-text'},gt={key:2,class:'list-detail-layout'},kt={class:'item-list'},Et=['onClick'],yt={class:'item-detail'},ht={class:'detail-name'},Nt={class:'detail-row'},Vt={class:'detail-value'},wt={class:'detail-row'},Ct={class:'detail-value'},xt={key:0,class:'detail-row'},Bt={class:'detail-value exclusion-hint'},St={key:1,class:'detail-row'},Tt={class:'detail-value replacement-hint'},Dt={key:2,class:'detail-row'},_t={class:'detail-value prerequisite-hint'},Mt={class:'detail-row'},Kt={class:'detail-value'},qt={class:'detail-actions'},Ot={key:1,class:'detail-placeholder'},jt={class:'step-footer'},At=['disabled'],zt=(0,n.defineComponent)({__name:'DLCManagementPage',emits:['next'],setup(e,{emit:t}){const a=t,l=(0,n.ref)(!1),o=(0,n.ref)(!1),c=(0,n.ref)('characters'),r=(0,n.ref)(null),i=(0,n.ref)(null),u=(0,n.ref)(null),d=(0,n.ref)([...ne.characterOptions]),v=(0,n.ref)(new Map(ne.localCharacterSelections)),m=(0,n.ref)([...re.eventOptions]),p=(0,n.ref)(new Map(re.localEventSelections)),f=(0,n.ref)([...fe.extensionOptions]),b=(0,n.ref)(new Map(fe.localExtensionSelections)),g=(0,n.ref)(null),k=(0,n.computed)(()=>r.value&&d.value.find(e=>e.value===r.value)||null),E=(0,n.computed)(()=>i.value&&m.value.find(e=>e.eventKey===i.value)||null),y=(0,n.computed)(()=>u.value&&f.value.find(e=>e.extensionKey===u.value)||null);async function h(){l.value=!0;try{const[e,t,a]=await Promise.all([be(),ye(),De()]);d.value=e.characterOptions,v.value=e.localCharacterSelections,g.value=e.bookName,m.value=t.eventOptions,p.value=t.localEventSelections,f.value=a.extensionOptions,b.value=a.localExtensionSelections}catch(e){console.error('Lỗi khi tải dữ liệu DLC:',e),d.value=[],v.value=new Map,m.value=[],p.value=new Map,f.value=[],b.value=new Map,g.value=null}finally{l.value=!1}}async function N(){await h()}function V(e){v.value=function(e,t){const a=new Map(e),n=a.get(t)??!1;return a.set(t,!n),a}(v.value,e)}function w(e){p.value=function(e,t){const a=new Map(e),n=a.get(t)??!1;return a.set(t,!n),a}(p.value,e)}function C(e){const t=function(e,t,a){const n=new Map(e),l=!n.get(a),o=t.find(e=>e.extensionKey===a);if(l&&o&&o.prerequisiteTargets.length>0){const{satisfied:a,missingPrerequisites:l}=function(e,t,a){const n=[];for(const l of a){const a=e.find(e=>e.extensionKey.includes(`[${l}]`));a&&t.get(a.extensionKey)||n.push(l)}return{satisfied:0===n.length,missingPrerequisites:n}}(t,n,o.prerequisiteTargets);if(!a)return{selections:e,success:!1,error:`Thiếu yêu cầu tiên quyết: ${l.join(', ')}`,missingPrerequisites:l}}if(n.set(a,l),l&&o)for(const e of o.exclusionTargets)for(const l of t)l.extensionKey===a||l.label!==e&&!l.extensionKey.includes(`[${e}]`)||n.set(l.extensionKey,!1);if(!l&&o)for(const e of t)e.extensionKey!==a&&n.get(e.extensionKey)&&e.prerequisiteTargets.includes(o.label)&&n.set(e.extensionKey,!1);return{selections:n,success:!0}}(b.value,f.value,e);t.success?b.value=t.selections:alert(t.error||'Thao tác thất bại')}async function x(){o.value=!0;try{if(g.value){const e=await async function(e,t,a){if(!function(e,t){for(const a of e)if((t.get(a.value)??!1)!==a.enabled)return!0;return!1}(e,t))return e;const n=Array.from(t).map(([e,t])=>({name:e,enabled:t}));return await s(n,a),e.map(e=>({...e,enabled:t.get(e.value)??!1}))}(d.value,v.value,g.value);d.value=e;const t=await async function(e,t,a){if(!function(e,t){for(const a of e)if((t.get(a.eventKey)??!1)!==a.enabled)return!0;return!1}(e,t))return e;const n=[];for(const a of e){const e=t.get(a.eventKey)??!1;for(const t of a.entries)n.push({name:t.name,enabled:e})}return await s(n,a),e.map(e=>{const a=t.get(e.eventKey)??!1;return{...e,enabled:a,entries:e.entries.map(e=>({...e,enabled:a}))}})}(m.value,p.value,g.value);m.value=t;const a=await _e(f.value,b.value,g.value);f.value=a}}catch(e){console.error('Lưu lựa chọn DLC thất bại:',e)}finally{o.value=!1}a('next')}return(0,n.onMounted)(()=>{h()}),(e,t)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',Ke,[t[21]||(t[21]=(0,n.createElementVNode)('h2',{class:'main-title'},'Quản lý DLC',-1)),(0,n.createElementVNode)('div',qe,[(0,n.createCommentVNode)(' Tab Điều hướng '),(0,n.createElementVNode)('div',Oe,[(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['tab-button',{active:'characters'===c.value}]),onClick:t[0]||(t[0]=e=>{c.value='characters',r.value=null})},[...t[6]||(t[6]=[(0,n.createElementVNode)('span',{class:'tab-label'},'Nhân vật',-1)])],2),(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['tab-button',{active:'events'===c.value}]),onClick:t[1]||(t[1]=e=>{c.value='events',i.value=null})},[...t[7]||(t[7]=[(0,n.createElementVNode)('span',{class:'tab-label'},'Sự kiện',-1)])],2),(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['tab-button',{active:'extensions'===c.value}]),onClick:t[2]||(t[2]=e=>{c.value='extensions',u.value=null})},[...t[8]||(t[8]=[(0,n.createElementVNode)('span',{class:'tab-label'},'Mở rộng',-1)])],2),(0,n.createElementVNode)('button',{class:'refresh-button',disabled:l.value,title:'Làm mới danh sách',onClick:N},[(0,n.createElementVNode)('span',{class:(0,n.normalizeClass)({'is-spinning':l.value})},'⟳',2)],8,je)]),(0,n.createCommentVNode)(' Vùng nội dung Tab '),(0,n.createElementVNode)('div',Ae,[(0,n.createCommentVNode)(' Danh sách nhân vật (DLC - Characters) '),(0,n.withDirectives)((0,n.createElementVNode)('div',ze,[l.value?((0,n.openBlock)(),(0,n.createElementBlock)('div',Le,'Đang tải danh sách nhân vật...')):0===d.value.length?((0,n.openBlock)(),(0,n.createElementBlock)('div',Pe,'Không tìm thấy nhân vật khả dụng')):((0,n.openBlock)(),(0,n.createElementBlock)('div',Ie,[(0,n.createElementVNode)('div',$e,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(d.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:e.value,class:(0,n.normalizeClass)(['list-item',{'toggled-on':v.value.get(e.value),selected:r.value===e.value}]),onClick:t=>r.value=e.value},(0,n.toDisplayString)(e.label),11,Fe))),128))]),(0,n.createElementVNode)('div',Re,[r.value&&k.value?((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:0},[(0,n.createElementVNode)('h3',He,(0,n.toDisplayString)(k.value.label),1),(0,n.createElementVNode)('div',We,[t[9]||(t[9]=(0,n.createElementVNode)('span',{class:'detail-label'},'Tác giả:',-1)),(0,n.createElementVNode)('span',Je,(0,n.toDisplayString)(k.value.author||'Chưa rõ'),1)]),(0,n.createElementVNode)('div',Ue,[t[10]||(t[10]=(0,n.createElementVNode)('span',{class:'detail-label'},'Thông tin:',-1)),(0,n.createElementVNode)('span',Ge,(0,n.toDisplayString)(k.value.info||'Không có'),1)]),(0,n.createElementVNode)('div',Ye,[(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['toggle-btn',{'toggled-on':v.value.get(r.value)}]),onClick:t[3]||(t[3]=e=>V(r.value))},(0,n.toDisplayString)(v.value.get(r.value)?'Đã bật':'Đã tắt'),3)])],64)):((0,n.openBlock)(),(0,n.createElementBlock)('div',Qe,'Vui lòng chọn một nhân vật để xem chi tiết'))])]))],512),[[n.vShow,'characters'===c.value]]),(0,n.createCommentVNode)(' Công tắc sự kiện (DLC - Events) '),(0,n.withDirectives)((0,n.createElementVNode)('div',Xe,[l.value?((0,n.openBlock)(),(0,n.createElementBlock)('div',Ze,'Đang tải danh sách sự kiện...')):0===m.value.length?((0,n.openBlock)(),(0,n.createElementBlock)('div',et,'Không tìm thấy sự kiện khả dụng')):((0,n.openBlock)(),(0,n.createElementBlock)('div',tt,[(0,n.createElementVNode)('div',at,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(m.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:e.eventKey,class:(0,n.normalizeClass)(['list-item',{'toggled-on':p.value.get(e.eventKey),selected:i.value===e.eventKey}]),onClick:t=>i.value=e.eventKey},(0,n.toDisplayString)(e.label),11,nt))),128))]),(0,n.createElementVNode)('div',lt,[i.value&&E.value?((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:0},[(0,n.createElementVNode)('h3',ot,(0,n.toDisplayString)(E.value.label),1),(0,n.createElementVNode)('div',st,[t[11]||(t[11]=(0,n.createElementVNode)('span',{class:'detail-label'},'Tác giả:',-1)),(0,n.createElementVNode)('span',ct,(0,n.toDisplayString)(E.value.author||'Chưa rõ'),1)]),(0,n.createElementVNode)('div',rt,[t[12]||(t[12]=(0,n.createElementVNode)('span',{class:'detail-label'},'Kích thước:',-1)),(0,n.createElementVNode)('span',it,(0,n.toDisplayString)(E.value.entries.length)+' mục',1)]),(0,n.createElementVNode)('div',ut,[t[13]||(t[13]=(0,n.createElementVNode)('span',{class:'detail-label'},'Thông tin:',-1)),(0,n.createElementVNode)('span',dt,(0,n.toDisplayString)(E.value.info||'Không có'),1)]),(0,n.createElementVNode)('div',vt,[(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['toggle-btn',{'toggled-on':p.value.get(i.value)}]),onClick:t[4]||(t[4]=e=>w(i.value))},(0,n.toDisplayString)(p.value.get(i.value)?'Đã bật':'Đã tắt'),3)])],64)):((0,n.openBlock)(),(0,n.createElementBlock)('div',mt,'Vui lòng chọn một sự kiện để xem chi tiết'))])]))],512),[[n.vShow,'events'===c.value]]),(0,n.createCommentVNode)(' Công tắc mở rộng (DLC - Extension) '),(0,n.withDirectives)((0,n.createElementVNode)('div',pt,[l.value?((0,n.openBlock)(),(0,n.createElementBlock)('div',ft,'Đang tải danh sách mở rộng...')):0===f.value.length?((0,n.openBlock)(),(0,n.createElementBlock)('div',bt,'Không tìm thấy phần mở rộng khả dụng')):((0,n.openBlock)(),(0,n.createElementBlock)('div',gt,[(0,n.createElementVNode)('div',kt,[((0,n.openBlock)(!0),(0,n.createElementBlock)(n.Fragment,null,(0,n.renderList)(f.value,e=>((0,n.openBlock)(),(0,n.createElementBlock)('button',{key:e.extensionKey,class:(0,n.normalizeClass)(['list-item',{'toggled-on':b.value.get(e.extensionKey),selected:u.value===e.extensionKey}]),onClick:t=>u.value=e.extensionKey},(0,n.toDisplayString)(e.label),11,Et))),128))]),(0,n.createElementVNode)('div',yt,[u.value&&y.value?((0,n.openBlock)(),(0,n.createElementBlock)(n.Fragment,{key:0},[(0,n.createElementVNode)('h3',ht,(0,n.toDisplayString)(y.value.label),1),(0,n.createElementVNode)('div',Nt,[t[14]||(t[14]=(0,n.createElementVNode)('span',{class:'detail-label'},'Tác giả:',-1)),(0,n.createElementVNode)('span',Vt,(0,n.toDisplayString)(y.value.author||'Chưa rõ'),1)]),(0,n.createElementVNode)('div',wt,[t[15]||(t[15]=(0,n.createElementVNode)('span',{class:'detail-label'},'Kích thước:',-1)),(0,n.createElementVNode)('span',Ct,(0,n.toDisplayString)(y.value.entries.length)+' mục',1)]),y.value.exclusionTargets.length>0?((0,n.openBlock)(),(0,n.createElementBlock)('div',xt,[t[16]||(t[16]=(0,n.createElementVNode)('span',{class:'detail-label'},'Xung đột:',-1)),(0,n.createElementVNode)('span',Bt,'Sẽ vô hiệu hóa: '+y.value.exclusionTargets.join(', '),1)])):(0,n.createCommentVNode)('v-if',!0),y.value.replacementTargets.length>0?((0,n.openBlock)(),(0,n.createElementBlock)('div',St,[t[17]||(t[17]=(0,n.createElementVNode)('span',{class:'detail-label'},'Thay thế:',-1)),(0,n.createElementVNode)('span',Tt,'Sẽ thay thế: '+y.value.replacementTargets.join(', '),1)])):(0,n.createCommentVNode)('v-if',!0),y.value.prerequisiteTargets.length>0?((0,n.openBlock)(),(0,n.createElementBlock)('div',Dt,[t[18]||(t[18]=(0,n.createElementVNode)('span',{class:'detail-label'},'Yêu cầu:',-1)),(0,n.createElementVNode)('span',_t,'Cần có: '+y.value.prerequisiteTargets.join(', '),1)])):(0,n.createCommentVNode)('v-if',!0),(0,n.createElementVNode)('div',Mt,[t[19]||(t[19]=(0,n.createElementVNode)('span',{class:'detail-label'},'Thông tin:',-1)),(0,n.createElementVNode)('span',Kt,(0,n.toDisplayString)(y.value.info||'Không có'),1)]),(0,n.createElementVNode)('div',qt,[(0,n.createElementVNode)('button',{class:(0,n.normalizeClass)(['toggle-btn',{'toggled-on':b.value.get(u.value)}]),onClick:t[5]||(t[5]=e=>C(u.value))},(0,n.toDisplayString)(b.value.get(u.value)?'Đã bật':'Đã tắt'),3)])],64)):((0,n.openBlock)(),(0,n.createElementBlock)('div',Ot,'Vui lòng chọn một phần mở rộng để xem chi tiết'))])]))],512),[[n.vShow,'extensions'===c.value]]),(0,n.createElementVNode)('div',jt,[(0,n.createElementVNode)('button',{class:'nav-button',disabled:o.value||l.value,onClick:x},[(0,n.createElementVNode)('span',null,(0,n.toDisplayString)(o.value?'Đang lưu...':'Bước sau'),1)],8,At)])])]))}});
